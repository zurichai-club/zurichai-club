---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";

export async function getStaticPaths() {
  const meetups = await getCollection("meetups");
  return meetups.map((meetup) => ({
    params: { slug: meetup.slug },
    props: { meetup }
  }));
}

const { meetup } = Astro.props;
const { Content } = await meetup.render();

const formatDateLong = (date) =>
  new Intl.DateTimeFormat("en-US", {
    month: "long",
    day: "numeric",
    year: "numeric"
  }).format(date);

const isSoldOut = meetup.data.status === "sold_out";
const isPast = meetup.data.status === "past";
const rsvpUrl = meetup.data.rsvpUrl;
const currentPath = Astro.url.pathname;
const showRsvp = rsvpUrl && rsvpUrl !== currentPath;
const calendarHref = `${import.meta.env.BASE_URL}calendar/${meetup.slug}.ics`;
---

<BaseLayout title={`${meetup.data.title} | AI Meetup Collective`}>
  <article>
    <header class="meetup-hero">
      <div class="meetup-hero__texture"></div>
      <div class="container meetup-hero__content">
        <a class="back-link" href="/"><- Back to home</a>
        <div class="tag-group" style="margin-bottom: 1rem;">
          {meetup.data.tags.map((tag) => (
            <span class="tag">{tag}</span>
          ))}
          {isSoldOut && <span class="tag tag--sold">SOLD OUT</span>}
        </div>
        <h1 class="meetup-hero__title">{meetup.data.title}</h1>
        <div class="meetup-meta">
          <span>{formatDateLong(meetup.data.date)}</span>
          <span>{meetup.data.time}</span>
          <span>{meetup.data.location}</span>
          <span>{meetup.data.speaker}</span>
        </div>
        <p class="meetup-why">{meetup.data.why}</p>
        <p class="meetup-quote">"{meetup.data.quote}"</p>
        <div class="meetup-actions">
          {showRsvp && !isSoldOut && (
            <a class="button button--primary" href={rsvpUrl}>
              RSVP Now
              <svg
                width="18"
                height="18"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                aria-hidden="true"
              >
                <path d="M5 12h14"></path>
                <path d="m12 5 7 7-7 7"></path>
              </svg>
            </a>
          )}
          {!isPast && (
            <a class="button button--invert" href={calendarHref} download>
              Add to Calendar
            </a>
          )}
        </div>
      </div>
    </header>

    <div class="detail-content">
      {meetup.data.speakers.length > 0 && (
        <section class="speaker-section">
          <h2>Speakers</h2>
          <div class="speaker-grid speaker-grid--detail">
            {meetup.data.speakers.map((speaker) => (
              <div class="speaker-card">
                <img
                  class="speaker-card__photo"
                  src={speaker.photo}
                  alt={`${speaker.name} headshot`}
                  loading="lazy"
                />
                <div class="speaker-card__body">
                  <div class="speaker-card__name">{speaker.name}</div>
                  <div class="speaker-card__role">{speaker.role}</div>
                  {speaker.companyUrl ? (
                    <a
                      class="speaker-card__company"
                      href={speaker.companyUrl}
                      target="_blank"
                      rel="noreferrer"
                    >
                      <span>{speaker.company}</span>
                    </a>
                  ) : (
                    <div class="speaker-card__company">
                      <span>{speaker.company}</span>
                    </div>
                  )}
                </div>
              </div>
            ))}
          </div>
        </section>
      )}
      <Content />
    </div>
  </article>
</BaseLayout>
